name: Build and Publish

on:
  release:
    types: [published]

jobs:
  windows-build:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Build with PyInstaller
      run: |
        pyinstaller odkt.py --add-data internal-ui.html:. --add-data missing-webview.html:. --icon icon.png
        Copy-Item -Path config.ini -Destination dist/odkt/
        Copy-Item -Path map_data.db -Destination dist/odkt/
        Compress-Archive -Path dist/* -Destination odkt_windows_${{ github.ref_name }}.zip
        dir
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-executable-windows-zip
        path: odkt_windows_${{ github.ref_name }}.zip

  linux-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install python3-gi python3-gi-cairo gir1.2-gtk-4.0
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Build with PyInstaller
      run: |
        pyinstaller odkt.py --add-data internal-ui.html:. --add-data missing-webview.html:. --icon icon.png
        cp config.ini dist/odkt/
        cp map_data.db dist/odkt/
        tar -czvf odkt_linux_${{ github.ref_name }}.tar.gz dist/*
        dir
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-executable-linux-zip
        path: odkt_linux_${{ github.ref_name }}.tar.gz

  executable-upload:
    runs-on: ubuntu-latest
    needs: [windows-build, linux-build]
    permissions:
      contents: write
    steps:
      - name: Download windows executable for job windows-build
        uses: actions/download-artifact@v4
        with:
          name: release-executable-windows-zip
      - name: Download linux executable for job linux-build
        uses: actions/download-artifact@v4
        with:
          name: release-executable-linux-zip
      - name: Upload zipped windows executable to release
        uses: JasonEtco/upload-to-release@master
        with:
          args: odkt_windows_${{ github.ref_name }}.zip application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload tarballed linux executable to release
        uses: JasonEtco/upload-to-release@master
        with:
          args: odkt_linux_${{ github.ref_name }}.tar.gz application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}