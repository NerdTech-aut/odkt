name: Build and Publish

on:
  release:
    types: [published]

jobs:
  windows-build:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_windows.txt
    - name: Build with PyInstaller
      run: |
        pyinstaller odkt.py --add-data internal-ui.html:. --icon icon.png --noconsole
        Copy-Item -Path config.ini -Destination dist/odkt/
        Copy-Item -Path map_data.db -Destination dist/odkt/
        Compress-Archive -Path dist/odkt/* -Destination odkt_windows_${{ github.ref_name }}.zip
        dir
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-executable-windows-zip
        path: odkt_windows_${{ github.ref_name }}.zip

  windows-build-with-debug-terminal:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_windows.txt
    - name: Build with PyInstaller
      run: |
        pyinstaller odkt.py --add-data internal-ui.html:. --icon icon.png
        Copy-Item -Path config.ini -Destination dist/odkt/
        Copy-Item -Path map_data.db -Destination dist/odkt/
        Compress-Archive -Path dist/odkt/* -Destination odkt_windows_debug_${{ github.ref_name }}.zip
        dir
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-executable-windows-debug-zip
        path: odkt_windows_debug_${{ github.ref_name }}.zip

  linux-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install libcairo2-dev=1.18.0-3build1 libcairo-gobject2=1.18.0-3build3 libjpeg-dev=8c-2ubuntu11 libgif-dev=5.2.2-1ubuntu1 libgirepository-1.0-1=1.80.1-1 libgirepository-2.0-dev=2.80.0-6ubuntu3.2 python3-gi=3.48.2-1 python3-gi-cairo=3.48.2-1 gir1.2-gtk-4.0=4.14.2+ds-1ubuntu1 glib-networking glib-networking-common glib-networking-services libcanberra-gtk-module libcanberra-gtk3-0t64=0.30-10ubuntu10 libcanberra-gtk3-module=0.30-10ubuntu10
        python -m pip install --upgrade pip
        pip install -r requirements_linux.txt
    - name: Build with PyInstaller
      run: |
        pyinstaller odkt.py --add-data internal-ui.html:. --icon icon.png
        cp config.ini dist/odkt/
        cp map_data.db dist/odkt/
        tar -C dist/odkt -czvf odkt_linux_${{ github.ref_name }}.tar.gz .
        dir
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-executable-linux-zip
        path: odkt_linux_${{ github.ref_name }}.tar.gz

  executable-upload:
    runs-on: ubuntu-latest
    needs: [windows-build, windows-build-with-debug-terminal, linux-build,]
    permissions:
      contents: write
    steps:
      - name: Download windows executable for job windows-build
        uses: actions/download-artifact@v4
        with:
          name: release-executable-windows-zip
      - name: Download windows executable for job windows-build-with-debug-terminal
        uses: actions/download-artifact@v4
        with:
          name: release-executable-windows-debug-zip
      - name: Download linux executable for job linux-build
        uses: actions/download-artifact@v4
        with:
          name: release-executable-linux-zip
      - name: Upload zipped windows executable to release
        uses: JasonEtco/upload-to-release@master
        with:
          args: odkt_windows_${{ github.ref_name }}.zip application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload zipped windows debug executable to release
        uses: JasonEtco/upload-to-release@master
        with:
          args: odkt_windows_debug_${{ github.ref_name }}.zip application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload tarballed linux executable to release
        uses: JasonEtco/upload-to-release@master
        with:
          args: odkt_linux_${{ github.ref_name }}.tar.gz application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}